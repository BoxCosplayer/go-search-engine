name: Release EXE on Push

on:
  push:
    branches:
      - main

permissions:
  contents: write
  packages: write

jobs:
  publish-linux-image:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Determine app version
        id: version
        run: |
          VERSION=$(python - <<'PY'
from pathlib import Path
lines = Path("backend/app/__init__.py").read_text().splitlines()
for line in lines:
    if line.startswith("__version__"):
        print(line.split("=", 1)[1].strip().strip('"').strip("'"))
        break
else:
    raise SystemExit("Could not determine application version.")
PY
)
          VERSION="${VERSION#"${VERSION%%[![:space:]]*}"}"
          VERSION="${VERSION%"${VERSION##*[![:space:]]}"}"
          if [ -z "$VERSION" ]; then
            echo "Version lookup returned empty string." >&2
            exit 1
          fi
          echo "APP_VERSION=$VERSION" >> "$GITHUB_ENV"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Linux image
        env:
          IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/go-server
        run: |
          docker buildx build \
            --platform linux/amd64 \
            -f docker/Dockerfile.linux \
            -t ${IMAGE_NAME}:${{ steps.version.outputs.version }} \
            -t ${IMAGE_NAME}:latest \
            --push .

  build-and-release:
    runs-on: windows-latest
    needs:
      - publish-linux-image
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install build dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Determine app version
        id: version
        shell: pwsh
        run: |
          $version = python -c 'from pathlib import Path; import sys; version = next((line.split("=",1)[1].strip().strip("\"").strip(chr(39)) for line in Path("backend/app/__init__.py").read_text().splitlines() if line.startswith("__version__")), None); print(version) if version else sys.exit("Could not determine application version.")'
          $version = $version.Trim()
          if (-not $version) {
            throw 'Could not determine application version.'
          }
          "APP_VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Prepare config
        shell: pwsh
        run: |
          if (-not (Test-Path "config.json")) {
            if (-not (Test-Path "config-template.txt")) {
              throw "config-template.txt not found; cannot generate config.json."
            }
            Copy-Item "config-template.txt" "config.json"
          }

      - name: Build executable with PyInstaller
        run: pyinstaller go-server.spec

      - name: Prepare executable asset
        id: prepare-exe
        shell: pwsh
        run: |
          $candidatePaths = @(
            (Join-Path "dist" "go-server.exe"),
            (Join-Path (Join-Path "dist" "go-server") "go-server.exe")
          )
          $exePath = $null
          foreach ($path in $candidatePaths) {
            if (Test-Path $path) {
              $exePath = $path
              break
            }
          }
          if (-not $exePath) {
            throw "Unable to locate go-server executable in expected paths."
          }
          $releaseDir = "release"
          if (-not (Test-Path $releaseDir)) {
            New-Item -Path $releaseDir -ItemType Directory | Out-Null
          }
          $assetName = "go-server-$env:APP_VERSION-windows.exe"
          $assetPath = Join-Path $releaseDir $assetName
          Copy-Item -Path $exePath -Destination $assetPath -Force
          $assetPathForward = $assetPath -replace '\\', '/'
          "asset_path=$assetPathForward" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Publish release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.APP_VERSION }}-${{ github.run_number }}
          name: v${{ env.APP_VERSION }}
          files: ${{ steps.prepare-exe.outputs.asset_path }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
