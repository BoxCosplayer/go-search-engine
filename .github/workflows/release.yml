name: Release EXE on Push

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install build dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Determine app version
        id: version
        shell: pwsh
        run: |
          $version = python -c 'from pathlib import Path; import sys; version = next((line.split("=",1)[1].strip().strip("\"").strip(chr(39)) for line in Path("backend/app/__init__.py").read_text().splitlines() if line.startswith("__version__")), None); print(version) if version else sys.exit("Could not determine application version.")'
          $version = $version.Trim()
          if (-not $version) {
            throw 'Could not determine application version.'
          }
          "APP_VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Build executable with PyInstaller
        run: pyinstaller go-server.spec

      - name: Package executable archive
        shell: pwsh
        run: |
          $zipName = "go-server-$env:APP_VERSION-windows.zip"
          $releaseDir = "release"
          if (-not (Test-Path $releaseDir)) {
            New-Item -Path $releaseDir -ItemType Directory | Out-Null
          }
          $zipPath = Join-Path $releaseDir $zipName
          if (Test-Path $zipPath) {
            Remove-Item $zipPath
          }
          Compress-Archive -Path "dist/go-server" -DestinationPath $zipPath
          "ZIP_PATH=$zipPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Publish release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.APP_VERSION }}-${{ github.run_number }}
          name: v${{ env.APP_VERSION }}
          files: ${{ env.ZIP_PATH }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
